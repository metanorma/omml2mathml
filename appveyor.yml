version: '{build}'

environment:
  matrix:
    - RUBY_VERSION: 25
    - RUBY_VERSION: 24
    - RUBY_VERSION: 23
    - RUBY_VERSION: _trunk

matrix:
  allow_failures:
    - RUBY_VERSION: _trunk

install:
  - ps: . { iwr -useb https://raw.githubusercontent.com/metanorma/metanorma-build-scripts/master/appveyor.ps1 } | iex
  - refreshenv

build_script:
  - git clone https://github.com/glejeune/ruby-xslt.git
  - set PATH=C:\Ruby%RUBY_VERSION%\bin;C:\msys64\mingw32\bin;C:\msys64\usr\bin;%PATH%
  - cd ruby-xslt
  - cd ext\xslt_lib
  - sed -i.back 's/"r"/"rb"/g' parser.c
  - set XsltDist=%ChocolateyInstall%\lib\xsltproc\dist
  - C:\Ruby%RUBY_VERSION%\bin\ruby extconf.rb --with-xml2-include=%XsltDist%\include\libxml2 --with-xslt-include=%XsltDist%\include --with-xml2-lib=%XsltDist%\lib --with-xslt-lib=%XsltDist%\lib
  - make DESTDIR=
  - make DESTDIR= install
  - cd ..\..
  - gem build ruby-xslt.gemspec
  - gem install ruby-xslt-0.9.10.gem -- --with-xml2-include=%XsltDist%\include\libxml2 --with-xslt-include=%XsltDist%\include --with-xml2-lib=%XsltDist%\lib --with-xslt-lib=%XsltDist%\lib
  - cd ..
  - bundle update
  - bundle install

before_test:
  - ruby -v
  - gem -v
  - bundle -v

test_script:
  - bundle exec rake

